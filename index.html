<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OZG OnePager – Hundehaltung anmelden (Demo)</title>
<style>
  :root {
    --bg:#0f1320; --card:#151a2e; --muted:#9aa4bf; --txt:#e8ecff; --accent:#7aa2ff; --ok:#3bd671; --warn:#ffcc66; --err:#ff6b6b;
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,#0f1320,#0b0e18);color:var(--txt);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:5;background:rgba(10,14,24,.8);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid #222}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{font-size:22px;margin:0 0 6px}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  button,.btn{background:var(--card);color:var(--txt);border:1px solid #2a3253;border-radius:10px;padding:9px 12px;cursor:pointer}
  button:hover,.btn:hover{border-color:var(--accent)}
  .pill{padding:6px 10px;border-radius:999px;font-size:12px}
  .ok{background:#173423;border-color:#2a6b4b;color:#b6ffcf}
  .warn{background:#3a3216;border-color:#6d5a1f;color:#ffeab6}
  main{padding:24px 0}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
  .card{background:var(--card);border:1px solid #222a45;border-radius:var(--radius);padding:16px}
  .steps{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
  .step{display:flex;align-items:center;gap:8px;background:#101425;border:1px solid #222a45;color:var(--muted);padding:8px 10px;border-radius:999px}
  .step.active{color:var(--txt);border-color:var(--accent);box-shadow:0 0 0 2px rgba(122,162,255,.15) inset}
  .step .n{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;background:#1c2342;color:#b9c6ff;font-weight:700}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;background:#0d1224;color:var(--txt);border:1px solid #283152;border-radius:10px;padding:10px}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(122,162,255,.15)}
  .hint{color:var(--muted);font-size:12px;margin-top:4px}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .errtxt{color:var(--err);font-size:12px;margin-top:4px}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:8px;font-size:13px}
  .divider{height:1px;background:#222a45;margin:12px 0}
  .badge{display:inline-block;border:1px dashed #375; border-radius:8px;padding:2px 8px;font-size:12px;color:#adf}
  .list{display:flex;flex-direction:column;gap:6px}
  .fileitem{display:flex;justify-content:space-between;align-items:center;background:#0d1224;border:1px solid #283152;border-radius:10px;padding:8px}
  /* Print confirmation */
  @media print {
    body{background:#fff;color:#000}
    header, .toolbar, .steps, #formPane, #rightPane .card:not(#confirmCard){display:none!important}
    #confirmCard{border:none}
  }
  /* High-contrast mode toggled via .hc on body */
  .hc :root{}
  .hc body{background:#000;color:#fff}
  .hc .card{background:#000;border-color:#fff}
  .hc input,.hc select,.hc textarea{background:#000;color:#fff;border-color:#fff}
  .hc .step{background:#000;border-color:#fff;color:#fff}
  .hc .step.active{border-color:#0ff;box-shadow:none}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>OZG OnePager – Hundehaltung anmelden</h1>
    <div class="sub">Vollständig clientseitig · Offline-fähig · JSON-Export · Druckbare Eingangsbestätigung · Demo ohne externe Libraries</div>
    <div class="toolbar">
      <span id="netState" class="pill ok">Status: Offline-fähig (Browser-Speicher)</span>
      <button id="btnContrast" title="Hoher Kontrast umschalten">Kontrast</button>
      <button id="btnFontUp" title="Schrift vergrößern">A+</button>
      <button id="btnFontDown" title="Schrift verkleinern">A-</button>
      <button id="btnExport">Export JSON</button>
      <label class="btn" style="position:relative;overflow:hidden">
        <input type="file" id="importFile" accept="application/json" style="position:absolute;inset:0;opacity:0;cursor:pointer"> Import JSON
      </label>
    </div>
  </div>
</header>

<main class="wrap grid">
  <section id="formPane" class="card">
    <div class="steps" id="steps"></div>
    <form id="theForm" novalidate></form>
    <div class="actions">
      <button id="prevBtn">Zurück</button>
      <button id="nextBtn">Weiter</button>
      <button id="submitBtn" style="display:none;background:linear-gradient(90deg,#3bd671,#7aa2ff);border:none;color:#06101a;font-weight:700">Verbindlich einreichen</button>
    </div>
  </section>

  <aside id="rightPane" class="card">
    <div class="kv">
      <div>Prozess:</div><div><strong>Hundehaltung anmelden</strong> <span class="badge">OZG-Demo</span></div>
      <div>Interne ID:</div><div><code id="procId">OZG-DEMO-HUND-001</code></div>
      <div>Vorgangsnummer:</div><div><code id="vnr">–</code></div>
      <div>Status:</div><div><span id="status">Entwurf</span></div>
    </div>
    <div class="divider"></div>
    <div class="list" id="liveSummary"></div>
  </aside>

  <section id="confirmCard" class="card" style="grid-column:1 / span 2;display:none">
    <h2>Eingangsbestätigung (Demo) – Hundehaltung</h2>
    <div id="confirmContent"></div>
    <div class="actions" style="justify-content:flex-start">
      <button onclick="window.print()">Drucken / PDF</button>
      <button id="btnNew">Neuen Antrag starten</button>
    </div>
  </section>
</main>

<script>
/* ------------------------ Mini “DSL” / Schema ------------------------ */
const PROCESS = {
  id: "OZG-DEMO-HUND-001",
  steps: [
    { key:"ident", name:"1. Identität", fields:[
      {key:"vorname", label:"Vorname", type:"text", required:true},
      {key:"nachname", label:"Nachname", type:"text", required:true},
      {key:"geburtsdatum", label:"Geburtsdatum", type:"date", required:true},
      {key:"strasse", label:"Straße & Hausnr.", type:"text", required:true},
      {key:"plz", label:"PLZ", type:"text", pattern:"^[0-9]{5}$", required:true, hint:"5-stellige Postleitzahl"},
      {key:"ort", label:"Ort", type:"text", required:true},
      {key:"email", label:"E-Mail für Rückfragen", type:"email", required:true},
      {key:"telefon", label:"Telefon (optional)", type:"tel"}
    ]},
    { key:"hund", name:"2. Hundedaten", fields:[
      {key:"hund_name", label:"Name des Hundes", type:"text", required:true},
      {key:"rasse", label:"Rasse", type:"text", required:true},
      {key:"geb_hund", label:"Geburtsdatum des Hundes", type:"date"},
      {key:"chip", label:"Transponder-/Chipnummer", type:"text", required:true, pattern:"^[0-9A-Za-z]{10,20}$", hint:"10–20 Zeichen, Buchstaben/Ziffern"},
      {key:"versicherung", label:"Hundehalter-Haftpflicht vorhanden", type:"select", required:true, options:["Ja","Nein"]},
      {key:"impfung", label:"Tollwutimpfung gültig bis", type:"date", required:true}
    ]},
    { key:"uploads", name:"3. Nachweise", fields:[
      {key:"u_versicherung", label:"Police Haftpflicht (PDF/JPG)", type:"file", accept:".pdf,.jpg,.jpeg,.png"},
      {key:"u_impfung", label:"Impfausweis-Seite (PDF/JPG)", type:"file", accept:".pdf,.jpg,.jpeg,.png"},
      {key:"datenschutz", label:"Datenschutzhinweise gelesen & akzeptiert", type:"checkbox", required:true}
    ]},
    { key:"review", name:"4. Prüfen & Absenden", fields:[
      {key:"bestaetigung", label:"Ich bestätige die Richtigkeit meiner Angaben", type:"checkbox", required:true},
      {key:"sign", label:"Elektronische Unterschrift (vollständiger Name)", type:"text", required:true, minLength:5}
    ]}
  ]
};

/* ------------------------ State & Storage ------------------------ */
const $ = sel => document.querySelector(sel);
const form = $("#theForm");
const stepsBar = $("#steps");
const statusSpan = $("#status");
const vnrEl = $("#vnr");
const liveSummary = $("#liveSummary");
const confirmCard = $("#confirmCard");
const confirmContent = $("#confirmContent");
const submitBtn = $("#submitBtn");
const nextBtn = $("#nextBtn");
const prevBtn = $("#prevBtn");
const netState = $("#netState");

let currentStep = 0;
let state = loadState() || { id:PROCESS.id, data:{}, files:{}, vnr:null, status:"Entwurf" };

function loadState(){
  try{ return JSON.parse(localStorage.getItem("ozg_demo_state")); }catch{ return null; }
}
function saveState(){ localStorage.setItem("ozg_demo_state", JSON.stringify(state)); }

/* IndexedDB for files */
let idb, filesStore;
const DB_NAME="ozg_demo_db", STORE="files";
function openDB(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
    };
    req.onsuccess = ()=>{ idb=req.result; filesStore = ()=>idb.transaction(STORE,"readwrite").objectStore(STORE); res(); };
    req.onerror = ()=>rej(req.error);
  });
}
openDB().catch(()=>console.warn("IndexedDB not available, fallback to memory"));

/* ------------------------ UI Rendering ------------------------ */
function renderSteps(){
  stepsBar.innerHTML = "";
  PROCESS.steps.forEach((s,i)=>{
    const el = document.createElement("div");
    el.className = "step"+(i===currentStep?" active":"");
    el.innerHTML = `<span class="n">${i+1}</span> <span>${s.name}</span>`;
    stepsBar.appendChild(el);
  });
}
function renderForm(){
  form.innerHTML = "";
  const step = PROCESS.steps[currentStep];
  step.fields.forEach(f=>{
    const wrap = document.createElement("div");
    wrap.className = "row";
    wrap.style.marginBottom="6px";
    wrap.innerHTML = `
      <div style="grid-column: span 12">
        <label for="${f.key}">${f.label}${f.required? " *":""}</label>
        ${fieldHTML(f)}
        ${f.hint? `<div class="hint">${f.hint}</div>`:""}
        <div class="errtxt" id="err_${f.key}" style="display:none"></div>
      </div>`;
    form.appendChild(wrap);
    initFieldBehavior(f);
  });
  prevBtn.style.visibility = currentStep>0? "visible":"hidden";
  nextBtn.style.display = currentStep<PROCESS.steps.length-1? "inline-block":"none";
  submitBtn.style.display = currentStep===PROCESS.steps.length-1? "inline-block":"none";
}
function fieldHTML(f){
  const val = state.data[f.key] ?? "";
  if(f.type==="select"){
    const opts = ["","..."].concat(f.options||[]);
    return `<select id="${f.key}" name="${f.key}" ${f.required?"required":""}>
      ${opts.map(o=>`<option ${o===val?"selected":""} value="${o===""?"":o}">${o===""?"Bitte wählen":o}</option>`).join("")}
    </select>`;
  }
  if(f.type==="textarea"){
    return `<textarea id="${f.key}" rows="4" ${f.required?"required":""}>${val}</textarea>`;
  }
  if(f.type==="checkbox"){
    const checked = (val===true||val==="true")? "checked":"";
    return `<input type="checkbox" id="${f.key}" ${checked}>`;
  }
  if(f.type==="file"){
    const count = (state.files[f.key]?.length)||0;
    return `<input type="file" id="${f.key}" ${f.accept?`accept="${f.accept}"`:""} ${f.multiple?"multiple":""}>
            <div class="hint">Gespeicherte Dateien: <span id="fc_${f.key}">${count}</span></div>`;
  }
  const extra = [];
  if(f.pattern) extra.push(`pattern="${f.pattern}"`);
  if(f.minLength) extra.push(`minlength="${f.minLength}"`);
  return `<input id="${f.key}" type="${f.type||"text"}" value="${String(val)}" ${f.required?"required":""} ${extra.join(" ")}>`;
}
function initFieldBehavior(f){
  const el = $("#"+f.key);
  if(!el) return;
  const setErr=(msg)=>{ const e=$("#err_"+f.key); if(!e) return; e.textContent=msg||""; e.style.display=msg?"block":"none"; };
  if(f.type==="file"){
    el.addEventListener("change", async ev=>{
      const files = Array.from(ev.target.files||[]);
      if(!files.length) return;
      const saved = [];
      for(const file of files){
        const buf = await file.arrayBuffer();
        const blob = new Blob([buf], {type:file.type||"application/octet-stream"});
        const id = `${f.key}:${Date.now()}:${Math.random().toString(36).slice(2,7)}`;
        try{
          if(filesStore) filesStore().put(blob, id);
          else { /* fallback */ state.files._mem = state.files._mem||{}; state.files._mem[id]=blob; }
          saved.push({id,name:file.name,type:file.type,size:file.size});
        }catch(e){ console.error(e); }
      }
      state.files[f.key] = (state.files[f.key]||[]).concat(saved);
      $("#fc_"+f.key).textContent = state.files[f.key].length;
      saveState(); renderUploadsSummary();
    });
  } else if (f.type==="checkbox"){
    el.addEventListener("change",()=>{ state.data[f.key]=el.checked; saveState(); renderSummary(); });
  } else {
    el.addEventListener("input", ()=>{ state.data[f.key]=el.value; saveState(); renderSummary(); validateOne(f, el, setErr); });
  }
  // initial validate
  if(f.type!=="file") validateOne(f, el, setErr, false);
}
function validateOne(f, el, setErr, show=true){
  let ok = true, msg="";
  if(f.required){
    if(f.type==="checkbox"){ ok = !!el.checked; if(!ok) msg="Erforderlich."; }
    else { ok = !!String(el.value||"").trim(); if(!ok) msg="Erforderlich."; }
  }
  if(ok && f.pattern && el.value){
    const re = new RegExp(f.pattern); ok = re.test(el.value); if(!ok) msg="Format ungültig.";
  }
  if(ok && f.minLength){ if((el.value||"").length<f.minLength){ ok=false; msg=`Mindestens ${f.minLength} Zeichen.`; } }
  setErr(show?msg:"");
  return ok;
}
function validateStep(){
  const step = PROCESS.steps[currentStep];
  let allOk = true;
  step.fields.forEach(f=>{
    const el = $("#"+f.key);
    if(!el) return;
    const setErr=(msg)=>{ const e=$("#err_"+f.key); if(!e) return; e.textContent=msg||""; e.style.display=msg?"block":"none"; };
    const ok = validateOne(f, el, setErr, true);
    allOk = allOk && ok;
  });
  return allOk;
}
function renderSummary(){
  const d = state.data;
  liveSummary.innerHTML = `
    <div><strong>Zusammenfassung</strong></div>
    <div class="divider"></div>
    <div class="kv">
      <div>Halter:</div><div>${esc(d.vorname)} ${esc(d.nachname)||""}</div>
      <div>Adresse:</div><div>${esc(d.strasse)||""}, ${esc(d.plz)||""} ${esc(d.ort)||""}</div>
      <div>E-Mail:</div><div>${esc(d.email)||"–"}</div>
      <div>Hund:</div><div>${esc(d.hund_name)||"–"} (${esc(d.rasse)||"–"})</div>
      <div>Chip:</div><div>${esc(d.chip)||"–"}</div>
      <div>Haftpflicht:</div><div>${esc(d.versicherung)||"–"}</div>
      <div>Impfung gültig bis:</div><div>${esc(d.impfung)||"–"}</div>
    </div>
    <div class="divider"></div>
    <div><strong>Uploads</strong></div>
    <div id="uploadsSum" class="list"></div>
  `;
  renderUploadsSummary();
}
function renderUploadsSummary(){
  const box = $("#uploadsSum");
  if(!box) return;
  box.innerHTML = "";
  const all = Object.entries(state.files||{});
  if(!all.length){ box.innerHTML = `<div class="hint">Keine Dateien gespeichert.</div>`; return; }
  all.forEach(([k,arr])=>{
    if(k==="_mem") return;
    (arr||[]).forEach(meta=>{
      const row = document.createElement("div");
      row.className="fileitem";
      row.innerHTML = `<span>${meta.name} <span class="hint">(${meta.type||"Datei"}, ${fmtSize(meta.size)})</span></span>
                       <button data-id="${meta.id}" data-key="${k}">Entfernen</button>`;
      row.querySelector("button").addEventListener("click", async (ev)=>{
        const id = ev.target.getAttribute("data-id");
        const key = ev.target.getAttribute("data-key");
        try{ if(filesStore) filesStore().delete(id); else if(state.files._mem) delete state.files._mem[id]; }catch{}
        state.files[key] = (state.files[key]||[]).filter(x=>x.id!==id);
        saveState(); renderSummary();
      });
      box.appendChild(row);
    });
  });
}

/* ------------------------ Navigation ------------------------ */
prevBtn.addEventListener("click",e=>{ e.preventDefault(); if(currentStep>0){ currentStep--; persistUI(); }});
nextBtn.addEventListener("click",e=>{ e.preventDefault(); if(validateStep()){ currentStep++; persistUI(); }});
submitBtn.addEventListener("click",e=>{
  e.preventDefault();
  if(!validateStep()) return;
  // basic plausibility: impfung in zukunft
  const impf = state.data.impfung? new Date(state.data.impfung):null;
  if(impf && impf < new Date()){ alert("Achtung: Die Tollwutimpfung scheint abgelaufen zu sein."); }
  state.vnr = "HZ-"+Date.now().toString(36).toUpperCase();
  state.status = "Eingereicht";
  saveState();
  showConfirmation();
});

function persistUI(){
  renderSteps(); renderForm(); renderSummary();
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ------------------------ Confirmation / Print ------------------------ */
function showConfirmation(){
  vnrEl.textContent = state.vnr || "–";
  statusSpan.textContent = state.status;
  confirmCard.style.display = "block";
  document.querySelector("#rightPane").scrollIntoView({behavior:"smooth"});

  const d = state.data;
  confirmContent.innerHTML = `
    <div class="kv">
      <div>Vorgangsnummer</div><div><strong>${esc(state.vnr)}</strong></div>
      <div>Eingangsdatum</div><div>${new Date().toLocaleString()}</div>
      <div>Prozess</div><div>Hundehaltung anmelden</div>
      <div>Halter</div><div>${esc(d.vorname)} ${esc(d.nachname)}, ${esc(d.strasse)}, ${esc(d.plz)} ${esc(d.ort)}</div>
      <div>Hund</div><div>${esc(d.hund_name)} (${esc(d.rasse)}), Chip: ${esc(d.chip)}</div>
      <div>Kontakt</div><div>${esc(d.email)} ${d.telefon?"/ "+esc(d.telefon):""}</div>
      <div>Versicherung</div><div>${esc(d.versicherung)||"–"}</div>
      <div>Impfung gültig bis</div><div>${esc(d.impfung)||"–"}</div>
      <div>Erklärung</div><div>Ich bestätige die Richtigkeit meiner Angaben: <em>${esc(d.sign)||"–"}</em></div>
    </div>
    <div class="divider"></div>
    <div class="hint">Dies ist eine Demo-Eingangsbestätigung. Keine echte behördliche Entscheidung.</div>
  `;
}

/* ------------------------ Export / Import ------------------------ */
$("#btnExport").addEventListener("click", ()=>{
  const payload = JSON.stringify(state, null, 2);
  const blob = new Blob([payload], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (state.vnr||"ozg_antrag_entwurf") + ".json";
  a.click();
  URL.revokeObjectURL(a.href);
});
$("#importFile").addEventListener("change", async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if(!data || data.id!==PROCESS.id) throw new Error("Falscher Prozess / Datei beschädigt.");
    state = data; saveState();
    statusSpan.textContent = state.status||"Entwurf";
    vnrEl.textContent = state.vnr||"–";
    currentStep = 0; persistUI();
    alert("Import erfolgreich.");
  }catch(err){ alert("Import fehlgeschlagen: "+err.message); }
});

/* ------------------------ A11y / UI Tweaks ------------------------ */
$("#btnContrast").addEventListener("click", ()=>{ document.body.classList.toggle("hc"); });
let fsize = 14;
$("#btnFontUp").addEventListener("click", ()=>{ fsize = Math.min(20, fsize+1); document.body.style.fontSize = fsize+"px"; });
$("#btnFontDown").addEventListener("click", ()=>{ fsize = Math.max(12, fsize-1); document.body.style.fontSize = fsize+"px"; });

/* ------------------------ Net status (just cosmetic) ------------------------ */
function updateNet(){
  const online = navigator.onLine;
  netState.className = "pill "+(online?"ok":"warn");
  netState.textContent = online? "Status: Online (lokale Speicherung aktiv)":"Status: Offline-fähig (Browser-Speicher)";
}
window.addEventListener("online",updateNet);
window.addEventListener("offline",updateNet);
updateNet();

/* ------------------------ Utils ------------------------ */
function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function fmtSize(n){ if(!n && n!==0) return "–"; const u=["B","KB","MB","GB"]; let i=0; while(n>1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(1)+" "+u[i]; }

/* ------------------------ Boot ------------------------ */
document.addEventListener("DOMContentLoaded", ()=>{
  renderSteps(); renderForm(); renderSummary();
  $("#btnNew").addEventListener("click", ()=>{
    state = { id:PROCESS.id, data:{}, files:{}, vnr:null, status:"Entwurf" };
    saveState();
    currentStep=0; persistUI();
    confirmCard.style.display="none";
  });
});
</script>
</body>
</html>
